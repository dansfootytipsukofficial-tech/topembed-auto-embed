name: Generate TopEmbed static site

on:
  schedule:
    - cron: '0 6 * * *' # daily at 06:00 UTC (adjust to your preferred time)
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer extractor deps
        run: |
          npm ci

      - name: Extract final stream URLs with Puppeteer
        run: |
            node scripts/extractor2.js --input embed/channels.json --output embed/channels.resolved.json --concurrency 4 || true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: python -m pip install --upgrade pip && pip install requests==2.31.0

      - name: Run generator
        run: python generate.py --output out --limit 200 || true

      - name: Prepare gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # prefer the resolved channels file if present
          if [ -f embed/channels.resolved.json ]; then
            mv embed/channels.resolved.json embed/channels.json
          fi
          # create an orphan gh-pages branch and replace contents
          git checkout --orphan gh-pages || true
          git rm -rf . >/dev/null 2>&1 || true
          mkdir -p .
          # copy generated site
          cp -R out/* .
          # move generated index into /embed/ so landing page can be the site root
          if [ -f index.html ]; then
            mkdir -p embed
            mv index.html embed/index.html
          fi
          # place landing_page.html at site root if present
          if [ -f landing_page.html ]; then
            cp landing_page.html index.html
          fi
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to publish"
          else
            git commit -m "Auto-generated site: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push -f origin gh-pages
          fi
